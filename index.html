<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Mapa Sanitario - Provincia de C√≥rdoba</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        #page-header {
            width: 100%;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1001;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        #header-blue {
            background-color: #005288;
            color: white;
            padding: 20px 20px;
            min-height: 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: sans-serif;
        }

        #header-title {
            font-size: 24px;
            font-weight: bold;
            flex-grow: 1;
        }

        #header-logos {
            display: flex;
            align-items: center;
        }

        .logo-container {
            margin-left: 20px;
            display: flex;
            align-items: center;
        }

        .logo-container img {
            height: 50px; /* Ajustado el tama√±o de los logos */
            max-width: none;
        }

        #header-bars {
            display: flex;
            height: 5px;
            width: 100%;
        }

        .bar {
            flex-grow: 1;
            height: 100%;
        }

        #filters-container {
            width: 100%;
            position: relative;
            background-color: #f8f8f8;
            padding: 15px 20px;
            box-sizing: border-box;
            z-index: 999;
            margin-top: 95px; /* Deja espacio para el header fijo */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            align-items: stretch; /* Asegura que los grupos de filtros est√©n a la misma altura */
        }

        .filter-group {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 6px rgba(0, 0, 0, 0.3);
            font-family: sans-serif;
            padding: 15px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-grow: 1; 
            min-width: 280px; 
            justify-content: space-between; 
        }

        .filter-group-title {
            font-weight: bold;
            color: #005288;
            margin-bottom: 10px;
            text-align: center;
            font-size: 16px;
        }

        .filter-group-content {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            align-items: center; 
        }

        #filters-container label {
            font-size: 15px;
            display: flex;
            align-items: center;
            cursor: pointer;
            white-space: nowrap;
        }

        #filters-container input[type="checkbox"],
        #filters-container select {
            margin-right: 8px;
            transform: scale(1.1);
        }

        #filters-container select {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        #map {
            height: calc(100vh - 95px - 140px); /* Ajusta si es necesario */
            width: 100%;
        }

        /* Panel de info de ZONA individual */
        #zona-info {
            display: none;
            position: absolute;
            top: 250px;
            right: 20px;
            background: #fff;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 1px 6px rgba(0, 0, 0, 0.3);
            font-family: sans-serif;
            z-index: 1100;
            width: 340px;
            flex-direction: column;
            max-height: calc(100vh - 280px);
            overflow-y: auto;
        }

        #zona-titulo {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 8px;
            color: #005288;
            text-align: center;
        }

        /* Panel de resumen de TODAS las ZONAS */
        #all-zones-summary-panel {
            display: none;
            position: absolute;
            top: 250px;
            right: 20px;
            background: #fff;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 1px 6px rgba(0, 0, 0, 0.3);
            font-family: sans-serif;
            z-index: 1100;
            width: 280px;
            flex-direction: column;
            max-height: calc(100vh - 280px);
            overflow-y: auto;
        }
        #all-zones-summary-panel h3 {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 8px;
            color: #005288;
            text-align: center;
        }
        #all-zones-summary-panel ul {
            list-style: none;
            padding: 0;
            margin: 0;
            font-size: 14px;
            line-height: 1.5;
        }
        #all-zones-summary-panel li {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
        }
        #all-zones-summary-panel li:last-child {
            border-bottom: none;
        }
        #all-zones-summary-panel li .zone-name {
            font-weight: bold;
            color: #333;
        }
        #all-zones-summary-panel li .zone-population {
            color: #005288;
            font-weight: bold;
        }
        
        /* Estilos para el bot√≥n de retorno - AJUSTADOS */
        #return-button {
        width: 30px;
        height: 27px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background-color 0.2s;
        margin: 0;
        margin-top: 5px; /* üîß Ajuste fino para alinear con el select */
        }

        #return-button:hover {
        background-color: #f0f0f0;
        }

        #return-button img {
        width: 50px;
        height: 50px;
        display: block;
        margin: 0;
        padding: 0;
        mix-blend-mode: multiply;
        }

        /* Estilos para las etiquetas de nombre sobre las capas */
        .layer-label {
            position: absolute;
            background-color: transparent;
            color: #005288;
            font-weight: bold;
            font-size: 14px;
            text-align: center;
            white-space: nowrap;
            pointer-events: none;
            transform: translate(-50%, -50%);
            text-shadow: 
                -1px -1px 3px rgba(255, 255, 255, 0.9), 
                1px -1px 3px rgba(255, 255, 255, 0.9), 
                -1px 1px 3px rgba(255, 255, 255, 0.9), 
                1px 1px 3px rgba(255, 255, 255, 0.9),
                0px 0px 5px rgba(255, 255, 255, 0.7);  
        }
    </style>
</head>
<body>
    <div id="page-header">
        <div id="header-blue">
            <div id="header-title">Mapa Sanitario - Provincia de C√≥rdoba</div>
            <div id="header-logos">
                <div class="logo-container">
                    <img src="https://reporteyanalisisdedatos.github.io/Mapa-Sanitario-Provincia-de-C-rdoba/SecreB.png" alt="Secretar√≠a de Salud" />
                </div>
                <div class="logo-container">
                    
                    <img src="https://reporteyanalisisdedatos.github.io/Mapa-Sanitario-Provincia-de-C-rdoba/HorizontalCTWhite.png" alt="Coordinaci√≥n Tecnol√≥gica" alt="Coordinaci√≥n Tecnol√≥gica" />
                </div>
            </div>
        </div>
        <div id="header-bars">
            <div class="bar" style="background-color: #FFDA63;"></div>
            <div class="bar" style="background-color: #DC3545;"></div>
            <div class="bar" style="background-color: #007BFF;"></div>
        </div>
    </div>

    <div id="filters-container">
        <div class="filter-group">
            <div class="filter-group-title">Filtros a Nivel Provincia</div>
            <div class="filter-group-content">
                <label><input type="checkbox" id="chkDEPARTAMENTOS" /> DEPARTAMENTOS</label>
                <label><input type="checkbox" id="chkLOCALIDADES" /> LOCALIDADES</label>
            </div>
        </div>

        <div class="filter-group">
            <div class="filter-group-title">Filtros a Nivel Capital</div>
            <div class="filter-group-content">
                <label for="selZONA">
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <div id="return-button" title="Volver a la vista general de Zonas" style="display: none; cursor: pointer;">
                            <img src="https://reporteyanalisisdedatos.github.io/Mapa-Sanitario-Provincia-de-C-rdoba/atras.png" alt="Volver" style="width: 22px; height: 22px;" />
                        </div>
                        <select id="selZONA">
                            <option value="">-- Seleccionar Zona --</option>
                            <option value="all">Todas las Zonas</option>
                        </select>
                    </div>
                </label>
                <label><input type="checkbox" id="chkCIRCUITO" /> CIRCUITOS</label>
                <label><input type="checkbox" id="chkSECCIONALES" /> SECCIONALES</label>
                
            </div>
        </div>
    </div>

    <div id="map"></div>

    <div id="zona-info">
        <div
            id="zona-titulo"
            style="font-weight: bold; font-size: 16px; margin-bottom: 8px; color: #005288;"
        >
            Poblaci√≥n de Zona
        </div>
        <div id="zona-datos"></div>
    </div>

    <div id="all-zones-summary-panel">
        <h3>Poblaci√≥n por Zona</h3>
        <div id="total-capital-population" class="total-population" style="display: none;"></div>
        <ul id="all-zones-list"></ul>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        let efectoresData = null;
        let capaEfectores = null;
        const capas = {}; // Objeto para almacenar las capas de GeoJSON (la geometr√≠a)
        const capasLabels = {}; // Objeto para almacenar las capas de etiquetas (los nombres)
        let allZonasFeatures = []; // Para guardar todas las features de zonas
        let allZonasDataLoaded = false; // Flag para saber si los datos de zonas est√°n cargados

        // Referencias a los elementos del DOM
        const selZONA = document.getElementById('selZONA');
        const returnButton = document.getElementById('return-button');
        const zonaInfoPanel = document.getElementById('zona-info');
        const allZonesSummaryPanel = document.getElementById('all-zones-summary-panel');
        const allZonesList = document.getElementById('all-zones-list');
        const totalCapitalPopulationDiv = document.getElementById('total-capital-population');
        
        let datosZonasPoblacion = [];

        document.addEventListener("DOMContentLoaded", () => {
            const map = L.map('map').setView([-31.42, -64.18], 11);

            const iconoEfectores = L.icon({
                iconUrl:'https://reporteyanalisisdedatos.github.io/Mapa-Sanitario-Provincia-de-C-rdoba/EFECTORES.png',
                iconSize: [36, 36],
                iconAnchor: [18, 36],
                popupAnchor: [0, -36],
            });

            

            const iconoHPA = L.icon({
                iconUrl: 'https://reporteyanalisisdedatos.github.io/Mapa-Sanitario-Provincia-de-C-rdoba/HOSP-HPA-PLM.png',
                iconSize: [38, 38],
                iconAnchor: [19, 38],
                popupAnchor: [0, -38],
            });

            const iconoCentroSalud = L.icon({
                iconUrl: 'https://reporteyanalisisdedatos.github.io/Mapa-Sanitario-Provincia-de-C-rdoba/CS.png', // Aseg√∫rate de tener esta imagen en la misma carpeta
                iconSize: [35, 35],
                iconAnchor: [15, 35],
                popupAnchor: [0, -35],
            });

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; OpenStreetMap contributors',
            }).addTo(map);

            const estilos = (feature) => ({
                color: feature.properties.stroke || '#3388ff',
                weight: feature.properties['stroke-width'] || 2,
                opacity: feature.properties['stroke-opacity'] || 1,
                fillColor: feature.properties.fill || '#3388ff',
                fillOpacity: feature.properties['fill-opacity'] || 0.3,
            });

            // Funci√≥n para obtener el nombre de la feature (para etiquetas y popups)
            function getFeatureName(props, layerName) {
                // *** POR FAVOR, REEMPLAZA 'nombre_propiedad_real' CON EL NOMBRE DE LA PROPIEDAD EN TUS JSONS ***
                // EJEMPLO: if (layerName === 'BARRIOS' && props.hasOwnProperty('NOMBRE_DEL_BARRIO')) { return props.NOMBRE_DEL_BARRIO; }
                if (layerName === 'BARRIOS' && props.hasOwnProperty('nombre_propiedad_real_barrio')) { 
                    return props.nombre_propiedad_real_barrio;
                }
                if (layerName === 'CIRCUITO' && props.hasOwnProperty('circuito')) { 
                    return props.circuito;
                }
                if (layerName === 'LOCALIDADES' && props.hasOwnProperty('nombre_propiedad_real_localidad')) { 
                    return props.nombre_propiedad_real_localidad;
                }
                if (layerName === 'SECCIONALES' && props.hasOwnProperty('nombre_seccional')) { // Ejemplo, si seccionales tiene una propiedad diferente
                    return props.nombre_seccional;
                }
                if (layerName === 'DEPARTAMENTOS' && props.hasOwnProperty('nombre_departamento')) { // Ejemplo
                    return props.nombre_departamento;
                }


                // Prioridad gen√©rica (si no se especifica una propiedad para la capa)
                if (props.name) return props.name;
                if (props.NOM_ZONA) return props.NOM_ZONA;
                if (props.CODIGO) return props.CODIGO;

                // Si no se encuentran las anteriores, busca la primera propiedad que parezca un nombre
                for (const key in props) {
                    if (typeof props[key] === 'string' && props[key].length > 1 && !/^\d+$/.test(props[key])) {
                        return props[key];
                    }
                }
                console.warn(`No se encontr√≥ una propiedad de nombre clara para la capa ${layerName}. Propiedades:`, props);
                return 'Sin nombre';
            }

            // Funci√≥n para calcular el centroide del bounding box de un pol√≠gono/multipol√≠gono (m√°s simple)
            function getCentroid(feature) {
                if (feature.geometry && feature.geometry.coordinates) {
                    try {
                        const geoJsonLayer = L.geoJSON(feature);
                        if (geoJsonLayer.getBounds().isValid()) {
                            return geoJsonLayer.getBounds().getCenter();
                        } else {
                            console.warn("Bounds inv√°lidos para la feature, no se pudo calcular el centroide:", feature);
                            return null;
                        }
                    } catch (e) {
                        console.error("Error al calcular el centroide para la feature:", feature, e);
                        return null;
                    }
                }
                return null;
            }

            // Cargar efectores y zonas
           const fetchEfectores = fetch("https://reporteyanalisisdedatos.github.io/Mapa-Sanitario-Provincia-de-C-rdoba/efectores.json")
                .then(res => {
                    if (!res.ok) throw new Error(`Error al cargar efectores.json: ${res.status}`);
                    return res.json();
                });

            const fetchZonasGeo = fetch("https://reporteyanalisisdedatos.github.io/Mapa-Sanitario-Provincia-de-C-rdoba/zonas.geojson")
                .then(res => {
                    if (!res.ok) throw new Error(`Error al cargar zonas.geojson: ${res.status}`);
                    return res.json();
                });

            const fetchZonasValores = fetch("https://reporteyanalisisdedatos.github.io/Mapa-Sanitario-Provincia-de-C-rdoba/zonas_valores.json")
                .then(res => {
                    if (!res.ok) throw new Error(`Error al cargar zonas_valores.json: ${res.status}`);
                    return res.json();
                });


            Promise.all([fetchEfectores, fetchZonasGeo, fetchZonasValores])
                .then(([efectores, zonasGeo, zonasValores]) => {
                    if (!efectores || !efectores.features) {
                        throw new Error("efectores.json no tiene la estructura esperada.");
                    }
                    if (!zonasGeo || !zonasGeo.features) {
                        throw new Error("zonas.geojson no tiene la estructura esperada.");
                    }
                    if (!Array.isArray(zonasValores)) {
                        throw new Error("zonas_valores.json no es un array.");
                    }

                    efectoresData = efectores.features;
                    allZonasFeatures = zonasGeo.features;
                    datosZonasPoblacion = zonasValores;
                    allZonasDataLoaded = true;

                    console.log("‚úÖ efectores cargados:", efectoresData.length);
                    poblarSelectorZonas(allZonasFeatures);
                    mostrarTodosEfectores();
                    selZONA.value = "";
                    zonaInfoPanel.style.display = 'none';
                    allZonesSummaryPanel.style.display = 'none';
                    returnButton.style.display = 'none';
                })
                .catch(error => {
                    console.error("Error cargando datos iniciales:", error);
                    if (error.message.includes("Failed to fetch")) {
                        alert("No se pudo conectar al servidor. Verific√° tu conexi√≥n a internet.");
                    } else {
                        alert(`Error al cargar datos: ${error.message}`);
                    }
                });

            const archivosCapas = [
                'CIRCUITO',
                'SECCIONALES',
                'DEPARTAMENTOS',
                'LOCALIDADES',
            ];
            const urlBase = "https://reporteyanalisisdedatos.github.io/Mapa-Sanitario-Provincia-de-C-rdoba/";
            archivosCapas.forEach((nombre) => {
                fetch(`${urlBase}${nombre}.json`)
                    .then((res) => {
                        if (!res.ok) {
                            throw new Error(`HTTP error! status: ${res.status} for ${nombre}.json`);
                        }
                        return res.json();
                    })
                    .then((geojson) => {
                        capas[nombre] = L.geoJSON(geojson, {
                            style: estilos,
                            onEachFeature: (feature, layer) => {
                                // Usar getFeatureName con el nombre de la capa
                                const nom = getFeatureName(feature.properties, nombre);
                                layer.bindPopup(`<strong>${nom}</strong>`);
                            },
                        });

                        // Crear y almacenar los marcadores de etiqueta para esta capa
                        const labelsGroup = L.layerGroup();
                        geojson.features.forEach(feature => {
                            const centroid = getCentroid(feature);
                            if (centroid) {
                                // Usar getFeatureName con el nombre de la capa
                                const name = getFeatureName(feature.properties, nombre);
                                if (name && name !== 'Sin nombre') { 
                                    const labelHtml = `<div class="layer-label">${name}</div>`;
                                    const customIcon = L.divIcon({
                                        className: 'custom-div-icon',
                                        html: labelHtml,
                                        iconSize: [0, 0], 
                                        iconAnchor: [0, 0]
                                    });
                                    const labelMarker = L.marker(centroid, { icon: customIcon });
                                    labelsGroup.addLayer(labelMarker);
                                }
                            }
                        });
                        capasLabels[nombre] = labelsGroup;

                    })
                    .catch((error) => {
                        console.error(`Error cargando ${nombre}.json:`, error);
                        console.log(`Aseg√∫rate de que ${nombre}.json exista, sea un GeoJSON v√°lido y tenga una propiedad de nombre legible.`);
                    });
            });

            function poblarSelectorZonas(zonasFeatures) {
                // Ordenar las zonas num√©ricamente
                zonasFeatures.sort((a, b) => {
                    const idA = parseInt((a.properties.name || '').replace('ZONA ', '').trim());
                    const idB = parseInt((b.properties.name || '').replace('ZONA ', '').trim());
                    return idA - idB;
                });

                zonasFeatures.forEach((feature) => {
                    const zona_id_str = (feature.properties.name || '').replace('ZONA ', '').trim();
                    if (zona_id_str) {
                        const option = document.createElement('option');
                        option.value = zona_id_str;
                        option.textContent = `ZONA ${zona_id_str}`;
                        selZONA.appendChild(option);
                    }
                });

                selZONA.onchange = (e) => {
                    const selectedValue = e.target.value;
                    if (capas.ZONA && map.hasLayer(capas.ZONA)) {
                        map.removeLayer(capas.ZONA);
                    }
                    zonaInfoPanel.style.display = 'none'; 
                    allZonesSummaryPanel.style.display = 'none'; 

                    if (selectedValue === 'all') {
                        capas.ZONA = L.geoJSON(
                            {
                                type: 'FeatureCollection',
                                features: allZonasFeatures,
                            },
                            {
                                style: estilos,
                                onEachFeature: (feature, layer) => {
                                    const zona_id_str_click = (feature.properties.name || '')
                                        .replace('ZONA ', '').trim();
                                    const zona_id_click = parseInt(zona_id_str_click) || 0;
                                    layer.on('click', (e) => {
                                        selZONA.value = zona_id_str_click; 
                                        mostrarZonaInfo(feature, zona_id_click, layer);
                                        map.fitBounds(layer.getBounds(), { padding: [20, 20] });
                                        returnButton.style.display = 'block'; 
                                        allZonesSummaryPanel.style.display = 'none'; 
                                    });
                                },
                            }
                        ).addTo(map);
                        mostrarTodosEfectores();
                        mostrarResumenTodasZonas();
                        map.setView([-31.42, -64.18], 11); 
                        returnButton.style.display = 'block'; // Mostrar bot√≥n cuando 'Todas las Zonas' est√° seleccionado
                    } else if (selectedValue) {
                        const selectedFeature = allZonasFeatures.find(f =>
                            (f.properties.name || '').replace('ZONA ', '').trim() === selectedValue
                        );
                        if (selectedFeature) {
                            capas.ZONA = L.geoJSON(selectedFeature, {
                                style: estilos,
                                onEachFeature: (feature, layer) => {
                                    const zona_id_str_click = (feature.properties.name || '')
                                        .replace('ZONA ', '').trim();
                                    const zona_id_click = parseInt(zona_id_str_click) || 0;
                                    layer.on('click', (e) => {
                                        mostrarZonaInfo(feature, zona_id_click, layer);
                                        map.fitBounds(layer.getBounds(), { padding: [20, 20] });
                                        returnButton.style.display = 'block'; 
                                        allZonesSummaryPanel.style.display = 'none'; 
                                    });
                                },
                            }).addTo(map);

                            const layerForBounds = L.geoJSON(selectedFeature);
                            if (layerForBounds) {
                                map.fitBounds(layerForBounds.getBounds(), { padding: [20, 20] });
                            }

                            mostrarEfectoresPorZona(parseInt(selectedValue));
                            mostrarZonaInfo(selectedFeature, parseInt(selectedValue), null); 
                            returnButton.style.display = 'block'; // Mostrar bot√≥n al seleccionar una zona espec√≠fica
                            allZonesSummaryPanel.style.display = 'none'; 
                        }
                    } else {
                        // Si se selecciona la opci√≥n "-- Seleccionar Zona --"
                        mostrarTodosEfectores();
                        zonaInfoPanel.style.display = 'none';
                        returnButton.style.display = 'none'; // Ocultar el bot√≥n si no hay zona seleccionada
                        allZonesSummaryPanel.style.display = 'none'; 
                        map.setView([-31.42, -64.18], 11); 
                    }
                };
            }

            // Manejador del bot√≥n de retorno
            returnButton.onclick = () => {
                if (selZONA.value === "all") { // Si estamos en "Todas las Zonas", ir a "-- Seleccionar Zona --"
                    selZONA.value = "";
                } else { // Si estamos en una zona espec√≠fica, ir a "Todas las Zonas"
                    selZONA.value = "all";
                }
                const event = new Event('change');
                selZONA.dispatchEvent(event); // Dispara el evento 'change'
            };


            document.getElementById('chkCIRCUITO').onchange = (e) =>
                toggleLayer('CIRCUITO', e.target.checked);
            document.getElementById('chkSECCIONALES').onchange = (e) =>
                toggleLayer('SECCIONALES', e.target.checked);
            document.getElementById('chkDEPARTAMENTOS').onchange = (e) =>
                toggleLayer('DEPARTAMENTOS', e.target.checked);
            document.getElementById('chkLOCALIDADES').onchange = (e) =>
                toggleLayer('LOCALIDADES', e.target.checked);

            function toggleLayer(nombre, visible) {
                if (!capas[nombre]) {
                    console.warn(`Capa de geometr√≠a '${nombre}' no cargada. Revisa el archivo JSON.`);
                    return;
                }
                // Las etiquetas son opcionales, pero si existen, se manejan
                if (capasLabels[nombre]) {
                    if (visible) {
                        capas[nombre].addTo(map);
                        capasLabels[nombre].addTo(map); 
                    } else {
                        map.removeLayer(capas[nombre]);
                        map.removeLayer(capasLabels[nombre]); 
                    }
                } else {
                    // Si no hay etiquetas, solo maneja la capa de geometr√≠a
                    if (visible) {
                        capas[nombre].addTo(map);
                    } else {
                        map.removeLayer(capas[nombre]);
                    }
                }
            }
            
            function mostrarTodosEfectores() {
                if (!efectoresData) {
                    console.error('‚ùå efectoresData no est√° cargado todav√≠a para mostrar todos los efectores.');
                    return;
                }
                if (capaEfectores) {
                    map.removeLayer(capaEfectores);
                }

                capaEfectores = L.geoJSON(
                    {
                        type: 'FeatureCollection',
                        features: efectoresData,
                    },
                    {
                        pointToLayer: (feature, latlng) => {
                            const nombre = (feature.properties?.centro || '').toLowerCase();
                            const tipo = (feature.properties?.tipo || '').toLowerCase();

                            let icono = iconoCentroSalud;

                            if (
                                tipo.includes('hospital') ||
                                tipo.includes('hpa') ||
                                nombre.includes('padre la monaca')
                            ) {
                                icono = iconoHPA;
                            } else if (
                                nombre.includes('medicina preventiva') ||
                                nombre.includes('dem') ||
                                nombre.includes('secretar√≠a de salud') ||
                                nombre.includes('secretaria de salud') ||
                                nombre.includes('adicciones') ||
                                tipo.includes('salud mental') ||
                                tipo.includes('pec')
                            ) {
                                icono = iconoEfectores;
                            }
                            
                            return L.marker(latlng, { icon: icono });
                        },
                       onEachFeature: (feature, layer) => {
                            const props = feature.properties;
                            const nombre = (props.centro || '').toLowerCase();

                            if (
                                nombre.includes('salud mental') &&
                                nombre.includes('direccion')
                            ) {
                                layer.bindPopup(`
                                    <div style="font-family: sans-serif; min-width: 240px;">
                                        <div style="font-weight: 600; font-size: 14px; margin-bottom: 6px; color: #005288; text-align: center;">
                                            Direcci√≥n de Salud Mental
                                        </div>
                                        <div style="font-size: 13px; line-height: 1.4; margin-bottom: 10px;">
                                            <div><b>Instituci√≥n:</b> Direcci√≥n de Salud Mental</div>
                                            <div><b>Tipo:</b> Salud Mental</div>
                                            <div><b>Direcci√≥n:</b> ${props.direccion || 'S/D'}</div>
                                        </div>
                                        <hr style="border: none; border-top: 1px solid #ccc; margin: 10px 0;" />
                                        <div style="font-weight: 600; font-size: 14px; margin-bottom: 6px; color: #005288; text-align: center;">
                                            Centro de Adicciones Lazos
                                        </div>
                                        <div style="font-size: 13px; line-height: 1.4;">
                                            <div><b>Instituci√≥n:</b> Centro de Adicciones Lazos</div>
                                            <div><b>Tipo:</b> Adicciones</div>
                                            <div><b>Direcci√≥n:</b> Mismo predio / entrada compartida</div>
                                        </div>
                                    </div>
                                `);
                            } else {
                                const zonaId = parseInt(props.zona);
                                const infoZona = datosZonasPoblacion.find(z => parseInt(z.Zona) === zonaId);

                                const datosCentro = {
                                    nombre: props.centro || 'Centro de Salud',
                                    institucion: props.institucion,
                                    tipo: props.tipo,
                                    direccion: props.direccion,

                                    poblacion: infoZona?.PoblacionTotal ?? 0,
                                    mujeres: infoZona?.Mujeres ?? 0,
                                    hombres: infoZona?.Varones ?? 0,
                                    sin_cobertura: infoZona?.PoblacionSinCobertura ?? 0,
                                    porcentaje_sin_cobertura: porcentaje(infoZona?.PoblacionSinCobertura, infoZona?.PoblacionTotal),
                                    hogares: infoZona?.Hogares ?? 0,
                                    hogares_nbi: infoZona?.HogaresNBI ?? 0
                                };

                                const popupContent = crearPopupCentroSalud(datosCentro);
                                layer.bindPopup(popupContent);
                            }
                        }

                    }
                ).addTo(map);
            }

            function mostrarEfectoresPorZona(zonaId) {
                if (!efectoresData) {
                    console.error('‚ùå efectoresData no est√° cargado todav√≠a.');
                    return;
                }
                if (capaEfectores) {
                    map.removeLayer(capaEfectores);
                }

               const efectoresEnZona = efectoresData.filter((e) => {
                    try {
                        const props = e.properties;
                        const nombre = (props?.centro || '').toLowerCase();
                        const tipo = (props?.tipo || '').toLowerCase();
                        const zonaMatch = parseInt(props?.zona) === zonaId;

                        const esValido =
                            tipo.includes('hospital') ||
                            tipo.includes('hpa') ||
                            nombre.includes('padre la monaca') ||
                            nombre.includes('medicina preventiva') ||
                            nombre.includes('dem') ||
                            nombre.includes('secretar√≠a de salud') ||
                            nombre.includes('secretaria de salud') ||
                            nombre.includes('adicciones') ||
                            tipo.includes('salud mental') ||
                            tipo.includes('pec');

                        return zonaMatch && esValido;
                    } catch (error) {
                        console.error('Error al procesar zona del efector:', e, error);
                        return false;
                    }
                });


                capaEfectores = L.geoJSON(
                    {
                        type: 'FeatureCollection',
                        features: efectoresEnZona,
                    },
                    {
                        pointToLayer: (feature, latlng) => {
                            const nombre = (feature.properties?.centro || '').toLowerCase();
                            const tipo = (feature.properties?.tipo || '').toLowerCase();

                            let icono = iconoCentroSalud;

                            if (
                                tipo.includes('hospital') ||
                                tipo.includes('hpa') ||
                                nombre.includes('padre la monaca')
                            ) {
                                icono = iconoHPA;
                            } else if (
                                nombre.includes('medicina preventiva') ||
                                nombre.includes('dem') ||
                                nombre.includes('secretar√≠a de salud') ||
                                nombre.includes('secretaria de salud') ||
                                nombre.includes('adicciones') ||
                                tipo.includes('salud mental') ||
                                tipo.includes('pec')
                            ) {
                                icono = iconoEfectores;
                            }
                            
                            return L.marker(latlng, { icon: icono });
                        },
                        onEachFeature: (feature, layer) => {
                                const props = feature.properties;
                                const nombre = (props.centro || '').toLowerCase();

                                if (
                                    nombre.includes('salud mental') &&
                                    nombre.includes('direccion')
                                ) {
                                    layer.bindPopup(`
                                        <div style="font-family: sans-serif; min-width: 240px;">
                                            <div style="font-weight: 600; font-size: 14px; margin-bottom: 6px; color: #005288; text-align: center;">
                                                Direcci√≥n de Salud Mental
                                            </div>
                                            <div style="font-size: 13px; line-height: 1.4; margin-bottom: 10px;">
                                                <div><b>Instituci√≥n:</b> Direcci√≥n de Salud Mental</div>
                                                <div><b>Tipo:</b> Salud Mental</div>
                                                <div><b>Direcci√≥n:</b> ${props.direccion || 'S/D'}</div>
                                            </div>
                                            <hr style="border: none; border-top: 1px solid #ccc; margin: 10px 0;" />
                                            <div style="font-weight: 600; font-size: 14px; margin-bottom: 6px; color: #005288; text-align: center;">
                                                Centro de Adicciones Lazos
                                            </div>
                                            <div style="font-size: 13px; line-height: 1.4;">
                                                <div><b>Instituci√≥n:</b> Centro de Adicciones Lazos</div>
                                                <div><b>Tipo:</b> Adicciones</div>
                                                <div><b>Direcci√≥n:</b> Mismo predio / entrada compartida</div>
                                            </div>
                                        </div>
                                    `);
                                } else {
                                    const zonaId = parseInt(props.zona);
                                    const infoZona = datosZonasPoblacion.find(z => parseInt(z.Zona) === zonaId);

                                    const datosCentro = {
                                        nombre: props.centro || 'Centro de Salud',
                                        institucion: props.institucion,
                                        tipo: props.tipo,
                                        direccion: props.direccion,

                                        poblacion: infoZona?.PoblacionTotal ?? 0,
                                        mujeres: infoZona?.Mujeres ?? 0,
                                        hombres: infoZona?.Varones ?? 0,
                                        sin_cobertura: infoZona?.PoblacionSinCobertura ?? 0,
                                        porcentaje_sin_cobertura: porcentaje(infoZona?.PoblacionSinCobertura, infoZona?.PoblacionTotal),
                                        hogares: infoZona?.Hogares ?? 0,
                                        hogares_nbi: infoZona?.HogaresNBI ?? 0
                                    };

                                    const popupContent = crearPopupCentroSalud(datosCentro);
                                    layer.bindPopup(popupContent);
                                }
                            }

                    }
                ).addTo(map);
            }


            function mostrarZonaInfo(feature, id, layer) {
                if (!efectoresData) {
                    console.error('‚ùå efectoresData no est√° cargado todav√≠a');
                    return;
                }

                const p = feature.properties;

                

                const infoZona = datosZonasPoblacion.find(z => parseInt(z.Zona) === parseInt(id));

                const poblacion = infoZona?.PoblacionTotal ?? 0;
                const mujeres = infoZona?.Mujeres ?? 0;
                const varones = infoZona?.Hombres ?? 0;
                const hogares = infoZona?.Hogares ?? 0;
                const hogaresNBI = infoZona?.HogaresNBI ?? 0;
                const cobertura = infoZona?.["Pob. Cobertura Publica Exclusiva"] ?? 0;

                const zonaInfoHtml = `
                    <div style="font-size: 28px; font-weight: bold; text-align: center; color: #005288; margin-bottom: 10px;">
                        ${poblacion.toLocaleString('es-AR')}
                    </div>
                    <div style="font-size: 14px; line-height: 1.5;">
                        <div><b style="color:#E5B8D9;">Mujeres:</b> ${mujeres.toLocaleString('es-AR')} <span style="color:gray">(${porcentaje(mujeres, poblacion)}%)</span></div>
                        <div><b style="color:#3C5AB7;">Varones:</b> ${varones.toLocaleString('es-AR')} <span style="color:gray">(${porcentaje(varones, poblacion)}%)</span></div>
                        <div><b>Hogares:</b> ${hogares.toLocaleString('es-AR')} <span style="color:gray">(${porcentaje(hogares, poblacion)}%)</span></div>
                        <div><b>Hogares NBI:</b> ${hogaresNBI.toLocaleString('es-AR')} <span style="color:gray">(${porcentaje(hogaresNBI, poblacion)}%)</span></div>
                        <div><b>Pob. Cobertura P√∫blica Excl:</b> ${cobertura.toLocaleString('es-AR')} <span style="color:gray">(${porcentaje(cobertura, poblacion)}%)</span></div>
                    </div>
                `;

                document.getElementById('zona-titulo').textContent = `Poblaci√≥n de Zona ${id}`;
                document.getElementById('zona-datos').innerHTML = zonaInfoHtml;
                zonaInfoPanel.style.display = 'flex';
                allZonesSummaryPanel.style.display = 'none'; 

                mostrarEfectoresPorZona(id);
            }

            function crearPopupCentroSalud(datos) {
                const tipo = (datos.tipo || '').toLowerCase();
                const nombre = (datos.nombre || '').toLowerCase();

                const isHospital = tipo.includes('hospital');
                const isHPA = tipo.includes('hpa');
                const isEfectorEspecialA = nombre.includes('padre la monaca');
                const isEfectorEspecialB = [
                    'medicina preventiva',
                    'dem',
                    'secretar√≠a de salud',
                    'secretaria de salud',
                    'salud mental',
                    'adicciones',
                    'pec'
                ].some(keyword => nombre.includes(keyword) || tipo.includes(keyword));

                const nombreLimpio = (datos.nombre || 'Centro de Salud').split('#')[0].trim();

                if (isHospital || isHPA || isEfectorEspecialA || isEfectorEspecialB) {
                    return `
                        <div style="font-family: sans-serif; min-width: 240px;">
                            <div style="font-weight: 600; font-size: 14px; margin-bottom: 6px; color: #005288; text-align: center;">
                                ${nombreLimpio}
                            </div>
                            <div style="font-size: 13px; line-height: 1.4;">
                                <div><b>Instituci√≥n:</b> ${nombreLimpio}</div>
                                <div><b>Tipo:</b> ${datos.tipo || 'S/D'}</div>
                                <div><b>Direcci√≥n:</b> ${datos.direccion || 'S/D'}</div>
                            </div>
                        </div>
                    `;
                } else {
                    const poblacionFormatted = datos.poblacion?.toLocaleString('es-AR') || '0';
                    const sinCoberturaFormatted = datos["Pob. Cobertura Publica Exclusiva"]?.toLocaleString('es-AR') || '0';
                    const mujeresFormatted = datos.mujeres?.toLocaleString('es-AR') || '0';
                    const hombresFormatted = datos.hombres?.toLocaleString('es-AR') || '0';
                    const hogaresFormatted = datos.hogares?.toLocaleString('es-AR') || '0';
                    const hogaresNBIFormatted = datos.hogares_nbi?.toLocaleString('es-AR') || '0';

                    return `
                        <div style="font-family: sans-serif; min-width: 240px;">
                            <div style="font-weight: 600; font-size: 14px; margin-bottom: 6px; color: #005288; text-align: center;">
                                ${nombreLimpio}
                            </div>
                            <div style="font-size: 24px; font-weight: 600; text-align: center; color: #005288; margin-bottom: 8px;">
                                ${poblacionFormatted}
                            </div>
                            <div style="font-size: 13px; line-height: 1.4;">
                                <div><b>Instituci√≥n:</b> ${nombreLimpio}</div>
                                <div><b>Tipo:</b> ${datos.tipo || 'S/D'}</div>
                                <div><b>Direcci√≥n:</b> ${datos.direccion || 'S/D'}</div>
                                <div><b>Pob. Cobertura P√∫blica Excl:</b> ${datos.sin_cobertura?.toLocaleString('es-AR') || '0'}
                                <span style="color:gray">(${(typeof datos.porcentaje_sin_cobertura === 'number') ? datos.porcentaje_sin_cobertura.toFixed(2) : '0'}%)</span>
                                </div>

                                <div><b style="color:#E5B8D9;">Mujeres:</b> ${mujeresFormatted} <span style="color:gray">(${porcentaje(datos.mujeres, datos.poblacion)}%)</span></div>
                                <div><b style="color:#3C5AB7;">Varones:</b> ${hombresFormatted} <span style="color:gray">(${porcentaje(datos.hombres, datos.poblacion)}%)</span></div>
                                <div><b>Hogares:</b> ${hogaresFormatted} <span style="color:gray">(${porcentaje(datos.hogares, datos.poblacion)}%)</span></div>
                                <div><b>Hogares NBI:</b> ${hogaresNBIFormatted} <span style="color:gray">(${porcentaje(datos.hogares_nbi, datos.poblacion)}%)</span></div>
                            </div>
                        </div>
                    `;
                }
            }



            function porcentaje(parte, total) {
                if (isNaN(parte) || isNaN(total) || total === 0 || parte === null || total === null) return '0';
                return ((parte / total) * 100).toFixed(2);
            }

            function mostrarResumenTodasZonas() {
                if (!allZonasDataLoaded) {
                    console.warn('Datos de zonas no cargados para mostrar el resumen.');
                    return;
                }

                allZonesList.innerHTML = ''; 

                allZonesSummaryPanel.querySelector('h3').textContent = 'Poblaci√≥n por Zona'; 
                totalCapitalPopulationDiv.style.display = 'none';

                const sortedZonas = [...allZonasFeatures].sort((a, b) => {
                    const idA = parseInt((a.properties.name || '').replace('ZONA ', '').trim());
                    const idB = parseInt((b.properties.name || '').replace('ZONA ', '').trim());
                    return idA - idB;
                });

                sortedZonas.forEach(feature => {
                    const id = (feature.properties.name || '').replace('ZONA ', '').trim();
                    const poblacion = feature.properties.poblacion || 0;
                    const poblacionFormatted = poblacion.toLocaleString('es-AR') ?? 'S/D';
                    if (id) {
                        const listItem = document.createElement('li');
                        listItem.innerHTML = `<span class="zone-name">ZONA ${id}:</span> <span class="zone-population">${poblacionFormatted}</span>`;
                        allZonesList.appendChild(listItem);
                    }
                });

                zonaInfoPanel.style.display = 'none'; 
                allZonesSummaryPanel.style.display = 'flex'; 
            }
        });
    </script>
</body>
</html>
